#!/usr/bin/env python
import os
import sys
import termenu

GITBIN = "/usr/bin/git"

class TitleMenu(termenu.Menu):
    def __init__(self, *args, **kwargs):
        super(TitleMenu, self).__init__(*args, **kwargs)
        if self.options[self.selected].startswith("-"):
            self._on_down()

    def _dispatch_key(self, key):
        retval = super(TitleMenu, self)._dispatch_key(key)
        if self.options[self.selected].startswith("-"):
            if self.selected == 0:
                super(TitleMenu, self)._on_down()
            elif self.selected == len(self.options)-1:
                super(TitleMenu, self)._on_up()
            elif key in ["up", "pageUp", "home"]:
                super(TitleMenu, self)._on_up()
            elif key in ["down", "pageDown", "end", "space"]:
                super(TitleMenu, self)._on_down()
        return retval

    def _build_menu_item(self, index, option):
        if option.startswith("-"):
            option = termenu.ansi.colorize(option, "white", bright=True)
        return super(TitleMenu, self)._build_menu_item(index, option)

def show_menu(*args, **kwargs):
    multiSelect = kwargs.get("multiSelect")
    del kwargs["multiSelect"]
    if multiSelect:
        class MenuClass(termenu.MultiSelectMixin, termenu.FilterMixin, TitleMenu):
            pass
    else:
        class MenuClass(termenu.FilterMixin, TitleMenu):
            pass
    menu = MenuClass(*args, **kwargs)
    return menu.show()

class GitRunner(object):
    def __init__(self, args):
        self._debug = False
        if args and args[0] == "--gitter-debug":
            self._debug = True
            args = args[1:]
        self.args = args

    def run(self):
        if not self.args or "--help" in self.args or self._free_args(self.args[1:]):
            return self._exec_git(self.args)
        self.command = self.args[0]
        self.args = self.args[1:]
        func = "_do_" + self.command.replace("-", "_")
        if hasattr(self, func):
            return getattr(self, func)()
        else:
            self._exec_default()

    def _exec_default(self):
        return self._exec_git([self.command] + self.args)

    def _exec_git(self, args):
        command = " ".join([GITBIN] + self._quote_args(args))
        if self._debug:
            print command
        else:
            return os.system(command)

    def _free_args(self, args):
        return [arg for arg in args if not arg.startswith("-")]

    def _options(self, args):
        return set([arg for arg in args if arg.startswith("-")])

    def _quote_args(self, args):
        return ['"%s"' % arg if " " in arg else arg for arg in args]

    # Getters for lists of items to show in a menu

    def _list_branches(self):
        branches = os.popen("%s branch" % GITBIN).readlines()
        branches = [b.strip("*").strip() for b in branches]
        return list(sorted(branches))

    def _list_status_files(self, workspaceStatuses="?M ", indexStatuses="?M "):
        lines = os.popen("%s status --porcelain" % GITBIN).readlines()
        files = [line[2:].strip() for line in lines if line[1] in workspaceStatuses or line[0] in indexStatuses]
        return list(files)

    def _list_commits(self):
        lines = os.popen("%s log --oneline" % GITBIN).readlines()
        lines = map(str.strip, lines)
        return lines

    def _command_with_menu(self, options, multiSelect):
        if not options:
            return
        selected = show_menu("", options, multiSelect=multiSelect)
        if not selected:
            return
        if not multiSelect:
            selected = [selected]
        return self._exec_git([self.command] + self.args + selected)

    def _command_with_hash(self):
        options = self._list_commits()
        if not options:
            return
        selected = termenu.show_menu("", options, multiSelect=False, columns=1, rows=15)
        if not selected:
            return
        selected = selected.split(" ", 1)[0]
        return self._exec_git([self.command] + self.args + [selected])

    # Command handlers

    def _do_checkout(self):
        branches = self._list_branches()
        if branches:
            branches.insert(0, "-- Branches --")
        files = self._list_status_files("M", "")
        if files:
            files.insert(0, "-- Files --")
        return self._command_with_menu(branches + files, multiSelect=True)

    def _do_add(self):
        modified = self._list_status_files("M", "")
        if modified:
            modified.insert(0, "-- Modified files --")
        untracked = self._list_status_files("?", "")
        if untracked:
            untracked.insert(0, "-- Untracked files --")
        both = self._list_status_files("", "U")
        if both:
            both.insert(0, "-- Both modified --")
        return self._command_with_menu(modified + both + untracked, multiSelect=True)

    def _do_reset(self):
        toBeCommitted = self._list_status_files("", "MA")
        if toBeCommitted:
            toBeCommitted.insert(0, "-- Files to be committed --")
        return self._command_with_menu(toBeCommitted, multiSelect=True)

    def _do_show(self):
        return self._command_with_hash()

    def _do_branch(self):
        options = self._options(self.args)
        if "-D" in options or "-d" in options:
            return self._command_with_menu(self._list_branches(), multiSelect=True)
        else:
            return self._exec_default()

if __name__ == "__main__":
    ret = GitRunner(sys.argv[1:]).run()
    sys.exit(ret or 127)
